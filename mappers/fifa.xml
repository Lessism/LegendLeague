<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="FIFA">


<!-- 	Image Convert	 -->

	<select id="image_convert" parameterType="map" resultType="_byte[]">
	
		SELECT
			img
		FROM
			Image
		WHERE
			img_no =
			
			<if test="no != null">
			
				#{no}
			
			</if>
			<if test="role != null">
			
				(
					SELECT
						<choose>
							<when test="role == 'Club'">
								emblem
							</when>
							<when test="role == 'Stadium'">
								std_img
							</when>
							<otherwise>
								profile
							</otherwise>
						</choose>
					FROM
						${role}
					WHERE
						<choose>
							<when test="role == 'Stadium'">
								std_name
							</when>
							<otherwise>
								name
							</otherwise>
						</choose>
						= #{name}
				)
				
			</if>
	
	</select>
	
	
<!-- 	Login	 -->

	<select id="login" parameterType="String" resultType="map">
	
		SELECT
			*
		FROM
			FIFA
		WHERE
			id = #{id}
			
	</select>
	
	
<!-- 	Join	 -->

	<insert id="join" parameterType="map">
	
		INSERT
			INTO FIFA (
				id,
				pw,
				name,
				role
			)
			VALUES (
				#{id},
				#{pw},
				#{name},
				#{role}
			);
			
		<if test="role == 'Club'">
		
			INSERT
				INTO Stadium (
					std_name
				)
				VALUES (
					#{stadium}
				);
			INSERT
				INTO Club (
					name,
					country,
					stadium
				)
				VALUES (
					#{name},
					#{country},
					#{stadium}
				);
		
		</if>
		<if test="role == 'Manager'">
		
			INSERT
				INTO Manager (
					name,
					country,
					birth,
					height,
					weight,
					ovr,
					tactic
				)
				VALUES (
					#{name},
					#{country},
					#{birth},
					#{height},
					#{weight},
					#{ovr},
					#{tactic}
				);
			
		</if>
		<if test="role == 'Player'">
		
			INSERT
				INTO Player (
					name,
					country,
					birth,
					height,
					weight,
					ovr,
					position
				)
				VALUES (
					#{name},
					#{country},
					#{birth},
					#{height},
					#{weight},
					#{ovr},
					#{position}
				);
		
		</if>
		<if test="img != null">
			
			INSERT
				INTO Image (
					img
				)
				VALUES (
					#{img}
				);
			UPDATE
				${role}
			SET
				<choose>
					<when test="role == 'Club'">
						emblem
					</when>
					<otherwise>
						profile
					</otherwise>
				</choose>
				= LAST_INSERT_ID()
			WHERE
				name = #{name};
				
		</if>
		<if test="img1 != null">
			
			INSERT
				INTO Image (
					img
				)
				VALUES (
					#{img1}
				);
			UPDATE
				Stadium
			SET
				std_img = LAST_INSERT_ID()
			WHERE
				std_name = #{stadium};
			
		</if>
	</insert>
	
	
<!--	 FIFA Club Lineup		-->
	
	<select id="club_lineup" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Player p
		LEFT
			JOIN Position po
		    ON p.position = po.position
		WHERE
			name = #{player0} OR
			name = #{player1} OR
			name = #{player2} OR
			name = #{player3} OR
			name = #{player4} OR
			name = #{player5} OR
			name = #{player6} OR
			name = #{player7} OR
			name = #{player8} OR
			name = #{player9} OR
			name = #{player10}
		ORDER BY
			po.no ASC, ovr DESC
	
	</select>
	
	
<!--	 FIFA Award		-->
	
	<select id="award" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Season
		LEFT
			JOIN ${role}
			ON ${award} = name
		WHERE
			season = #{season}
			
	</select>
	
	
<!--	 FIFA Award Lineup		-->
	
	<select id="award_lineup" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Player p
		LEFT
			JOIN Position po
			ON p.position = po.position
		LEFT
			JOIN (
				SELECT
					*, COUNT(round) countround, AVG(rating) avgrating, SUM(goal) sumgoal, SUM(assist) sumassist
				FROM
					Score
				WHERE
					season	= #{season}	AND
					player	= #{player0} OR
					season	= #{season}	AND
					player	= #{player1} OR
					season	= #{season}	AND
					player	= #{player2} OR
					season	= #{season}	AND
					player	= #{player3} OR
					season	= #{season}	AND
					player	= #{player4} OR
					season	= #{season}	AND
					player	= #{player5} OR
					season	= #{season}	AND
					player	= #{player6} OR
					season	= #{season}	AND
					player	= #{player7} OR
					season	= #{season}	AND
					player	= #{player8} OR
					season	= #{season}	AND
					player	= #{player9} OR
					season	= #{season}	AND
					player	= #{player10}
				GROUP BY
					season, player
			) AS score
	        ON player = name
		WHERE
			name = #{player0} OR
			name = #{player1} OR
			name = #{player2} OR
			name = #{player3} OR
			name = #{player4} OR
			name = #{player5} OR
			name = #{player6} OR
			name = #{player7} OR
			name = #{player8} OR
			name = #{player9} OR
			name = #{player10}
		ORDER BY
			po.no ASC, ovr DESC
			
	</select>
	
	
<!--	 FIFA Award Club		-->
	
	<select id="award_club" parameterType="map" resultType="map">
	
		SELECT
			*, 'Club' role, 'champion' award,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Champion',''))) DIV CHAR_LENGTH('Champion') countchampion
		FROM
			awardclub ac
		LEFT
			JOIN Club c
			ON ac.name = c.name
		WHERE
			season = #{season}
			
	</select>
	
	
<!--	 FIFA Award Manager		-->
	
	<select id="award_manager" parameterType="map" resultType="map">
	
		SELECT
			*, 'Manager' role, 'manager' award,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Champion',''))) DIV CHAR_LENGTH('Champion') countchampion
		FROM
			awardmanager am
		LEFT
			JOIN Manager m
			ON am.name = m.name
		WHERE
			season = #{season}
			
	</select>
	
	
<!--	 FIFA Award Player		-->
	
	<select id="award_player" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Season
		WHERE
			season = #{season}
			
	</select>
	
	
<!--	 FIFA Award Ballon Dor		-->
	
	<select id="award_ballondor" parameterType="map" resultType="map">
	
		SELECT
			*, 'Player' role, 'ballondor' award,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Champion',''))) DIV CHAR_LENGTH('Champion') countchampion,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Ballon Dor',''))) DIV CHAR_LENGTH('Ballon Dor') countballondor,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Goal Scorer',''))) DIV CHAR_LENGTH('Goal Scorer') countgoalscorer,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Assist Provider',''))) DIV CHAR_LENGTH('Assist Provider') countassistprovider
		FROM
			ballondor b
		LEFT
			JOIN Player p
			ON b.name = p.name
		LEFT
			JOIN Position po
            ON p.position = po.position
		WHERE
			season = #{season}
			
	</select>
	
	
<!--	 FIFA Award Goal Scorer		-->
	
	<select id="award_goalScorer" parameterType="map" resultType="map">
	
		SELECT
			*, 'Player' role, 'goalScorer' award,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Champion',''))) DIV CHAR_LENGTH('Champion') countchampion,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Ballon Dor',''))) DIV CHAR_LENGTH('Ballon Dor') countballondor,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Goal Scorer',''))) DIV CHAR_LENGTH('Goal Scorer') countgoalscorer,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Assist Provider',''))) DIV CHAR_LENGTH('Assist Provider') countassistprovider
		FROM
			goalscorer g
		LEFT
			JOIN Player p
			ON g.name = p.name
		LEFT
			JOIN Position po
            ON p.position = po.position
		WHERE
			season = #{season}
			
	</select>
	
	
<!--	 FIFA Award Assist Provider		-->
	
	<select id="award_assistProvider" parameterType="map" resultType="map">
	
		SELECT
			*, 'Player' role, 'assistProvider' award,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Champion',''))) DIV CHAR_LENGTH('Champion') countchampion,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Ballon Dor',''))) DIV CHAR_LENGTH('Ballon Dor') countballondor,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Goal Scorer',''))) DIV CHAR_LENGTH('Goal Scorer') countgoalscorer,
			(CHAR_LENGTH(history)-CHAR_LENGTH(REPLACE(history,'Assist Provider',''))) DIV CHAR_LENGTH('Assist Provider') countassistprovider
		FROM
			assistprovider a
		LEFT
			JOIN Player p
			ON a.name = p.name
		LEFT
			JOIN Position po
            ON p.position = po.position
		WHERE
			season = #{season}
			
	</select>
	
	
<!--	 FIFA Award List		-->
	
	<select id="award_list" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Season
		LEFT
			JOIN ${role}
			ON ${award} = name
		ORDER BY
			season DESC
			
	</select>
	
	
<!--	 FIFA Award Odds		-->
	
	<select id="award_odds" parameterType="map" resultType="map">
	
		SELECT
			MAX(win) win, MAX(draw) draw, MAX(lose) lose, MAX(game) game,
			MAX(win) / MAX(game) winodds, MAX(draw) / MAX(game) drawodds, MAX(lose) / MAX(game) loseodds,
			MAX(point) maxpoint, MAX(goalfor) maxgoalfor, MAX(goalagainst) maxgoalagainst
		FROM
			Ranking
		WHERE
			season	= #{season} AND
		<if test="role != 'Club'">
			club	= #{club}
		</if>
		<if test="role == 'Club'">
			club	= #{name}
		</if>
		GROUP BY
			season, club
			
	</select>
	
	
<!--	 FIFA Award Score		-->
	
	<select id="award_score" parameterType="map" resultType="map">
	
		SELECT
			*, COUNT(round) countround, AVG(rating) avgrating, SUM(goal) sumgoal, SUM(assist) sumassist
		FROM
			Score
		WHERE
			season	= #{season}	AND
		    player	= #{name}
		GROUP BY
			season, player
			
	</select>
	
	
<!--	 FIFA Award Score Player		-->
	
	<select id="award_score_player" parameterType="map" resultType="map">
	
		SELECT
			*, COUNT(round) countround, AVG(rating) avgrating, SUM(goal) sumgoal, SUM(assist) sumassist
		FROM
			Score
		WHERE
			season	= #{season}	AND
		    player	= #{name}
		GROUP BY
			season, player
			
	</select>
	
	
<!--	 FIFA List		-->
	
	<select id="list" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			${role}
			
			<if test="role == null">
			
				Club
				
			</if>
			
		ORDER BY
			ovr DESC
			
	</select>
	
	
<!--	 Roster list		-->
	
	<select id="roster_list" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Club
		WHERE
		
			<if test="name == null">
			
				roster = 1
				
			</if>
			<if test="name != null">
			
				name = #{name}
				
			</if>
			
		ORDER BY
			ovr DESC
			
	</select>
	
	
<!-- 	Info Club	 -->

	<select id="info_club" parameterType="String" resultType="map">
	
		SELECT
			*
		FROM
			Club
		WHERE
			name = #{name}
			
	</select>
	
	
<!-- 	Info Manager	 -->

	<select id="info_manager" parameterType="String" resultType="map">
	
		SELECT
			*
		FROM
			Manager
		WHERE
			name = #{name}
			
	</select>
	
	
<!-- 	Info Player	 -->

	<select id="info_player" parameterType="String" resultType="map">
	
		SELECT
			p.*,po.*
		FROM
			Player p
		LEFT JOIN Position po
			ON p.position = po.position
		WHERE
			p.name = #{name}
	
	</select>
	
	
</mapper>