<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="League">


<!--	League Season Round		-->

	<select id="season_round" resultType="map">
		
		SELECT
			*
		FROM
			Season
		ORDER BY
			season DESC
		LIMIT
			1
		
	</select>
	
	
<!--	League information		-->

	<select id="information" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Club
		WHERE
			roster = 1
		ORDER BY
			ovr DESC
	
	</select>
	
	
<!--	Key Player		-->

	<select id="keyplayer" resultType="map">
	
		SELECT
			*
		FROM
			Player
		WHERE
			club = #{name}
		ORDER BY
			ovr DESC
		LIMIT
			1
			
	</select>
	
	
<!--	Ranking		-->

	<select id="ranking" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Ranking
		WHERE
			round = #{round}
		ORDER BY
			point DESC
	
	</select>
	
	
<!--	Score ranking		-->
	
	<select id="score_ranking" resultType="map">
	
		SELECT
			*,
			<if test="score == 'goal'"> SUM(goal) goalscorer </if>
			<if test="score == 'assist'"> SUM(assist) assistprovider </if>
			<if test="score == 'rating'"> AVG(rating) toprating </if>
		FROM
			Score
		WHERE
			season = #{season}
			<if test="score == 'goal'">AND NOT goal = 0 </if>
			<if test="score == 'assist'">AND NOT assist = 0 </if>
		group by
			player
		ORDER BY
			<if test="score == 'goal'"> goalscorer DESC, assist DESC, rating DESC </if>
			<if test="score == 'assist'"> assistprovider DESC, goal DESC, rating DESC </if>
			<if test="score == 'rating'"> toprating DESC, goal DESC, assist DESC </if>
		LIMIT
			3
	
	</select>
	
<!--	Match		-->

	<select id="match" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Round
		WHERE
			season	= #{season} AND
			round	= #{round}
	
	</select>
	
	
<!--	Match schedule		-->

	<insert id="match_schedule" parameterType="map">
	
		<foreach collection="versus" index="idx" separator=";" close=";">
		
			INSERT
				INTO Round (
					season,
					round,
					versus
				)
				VALUES (
					#{season},
					#{round},
					#{versus[${idx}]}
				)
		
		</foreach>
		<foreach collection="club" index="idx" separator=";">
		
			INSERT
				INTO Ranking (
					season,
					round,
					club
				)
				VALUES (
					#{season},
					#{round},
					#{club[${idx}]}
				)
		
		</foreach>
	
	</insert>
	
	
<!--	Start Season		-->

	<update id="start_season" parameterType="map">
	
		UPDATE
			League
		SET
			round = 1
		WHERE
			season = #{season};
			
		UPDATE
			Season
		SET
			round = 1
		WHERE
			season = #{season}
	
	</update>
	
	
<!--	Lineup		-->

	<select id="lineup" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			${role}
		WHERE
			club = #{name}
			
	</select>
	
	
<!--	Insert Score		-->

	<insert id="insert_score" parameterType="map">
	
		INSERT
			INTO Score (
				season,
				round,
				club,
				player,
				rating,
				goal,
				assist,
				opponent
			)
			VALUES (
				#{season},
				#{round},
				#{club},
				#{name},
				#{rating},
				#{goal},
				#{assist},
				#{opponent}
			)
	
	</insert>
	
	
<!--	Update Round		-->

	<update id="update_round" parameterType="map">
	
		UPDATE
			Round
		SET
			lineup	= #{lineup},
			score	= #{score}
		WHERE
			season	= #{season}	AND
			round	= #{round}	AND
			versus	= #{versus}
	
	</update>
	
	
<!--	Update Ranking	-->
	
	<update id="update_ranking" parameterType="map">
	
		UPDATE
			Ranking
		SET
			game	= 	#{round},
			win 	= 	( SELECT * FROM (
							SELECT
								win
							FROM
								Ranking
							WHERE
								season	= #{season}	AND
								round	= #{round}	AND
								club	= #{name}
						) AS win )
		<if test="win != null"> + #{win}</if>,
			draw	=	( SELECT * FROM (
							SELECT
								draw
							FROM
								Ranking
							WHERE
								season	= #{season}	AND
								round	= #{round}	AND
								club	= #{name}
						) AS draw )
		<if test="draw != null"> + #{draw}</if>,
			lose	=	( SELECT * FROM (
							SELECT
								lose
							FROM
								Ranking
							WHERE
								season	= #{season}	AND
								round	= #{round}	AND
								club	= #{name}
						) AS lose )
		<if test="lose != null"> + #{lose}</if>
		WHERE
			season	= #{season}	AND
			round	= #{round}	AND
			club	= #{name};
			
		UPDATE
			Ranking
		SET
			point = 
				(SELECT wd.win * 3 + wd.draw FROM 
					(
						SELECT
							win, draw
						FROM
							Ranking
						WHERE
							season	= #{season}	AND
							round	= #{round}	AND
							club	= #{name}
					) AS wd
				)
		WHERE
			season	= #{season}	AND
			round	= #{round}	AND
			club	= #{name}
	
	
	</update>
	
	
<!--	Check Round		-->

	<select id="check_round" parameterType="map" resultType="int">
	
		SELECT
			SUM(game = ( SELECT * FROM (
							SELECT
								MAX(round)
							FROM
								Round
							WHERE
								season = #{season}
						) AS round )
			)
		<if test="name == null">
		=	( SELECT * FROM (
				SELECT
					COUNT(round)
				FROM
					Ranking
				WHERE
					season	= #{season}	AND
					round	= #{round}
			) AS round )
		</if>
		FROM
			Ranking
		WHERE
			season	= #{season} AND
		    round	= #{round}
		<if test="name != null"> AND
			club = #{name}
		</if>
	
	</select>
	
	
<!--	Next Ranking		-->

	<update id="next_ranking" parameterType="map">
	
		UPDATE
			Ranking
		SET
			game	= 	#{round},
			win 	= 	( SELECT * FROM (
							SELECT
								win
							FROM
								Ranking
							WHERE
								season	= #{season}	AND
								round	= #{round}	AND
								club	= #{name}
						) AS win ),
			draw	=	( SELECT * FROM (
							SELECT
								draw
							FROM
								Ranking
							WHERE
								season	= #{season}	AND
								round	= #{round}	AND
								club	= #{name}
						) AS draw ),
			lose	=	( SELECT * FROM (
							SELECT
								lose
							FROM
								Ranking
							WHERE
								season	= #{season}	AND
								round	= #{round}	AND
								club	= #{name}
						) AS lose )
		WHERE
			season	= #{season}	AND
			round	= #{round} + 1	AND
			club	= #{name};
			
		UPDATE
			Ranking
		SET
			point = 
				(SELECT wd.win * 3 + wd.draw FROM 
					(
						SELECT
							win, draw
						FROM
							Ranking
						WHERE
							season	= #{season}	AND
							round	= #{round}	AND
							club	= #{name}
					) AS wd
				)
		WHERE
			season	= #{season}	AND
			round	= #{round} + 1	AND
			club	= #{name}
	
	</update>
	
<!--	Next Round		-->

	<update id="next_round" parameterType="map">
	
		UPDATE
			League
		SET
			round	= #{round} + 1
		WHERE
			season	= #{season};
		
		UPDATE
			Season
		SET
			round	= #{round} + 1
		WHERE
			season	= #{season}
	
	</update>
	
	
<!--	Result Game		-->
	
	<select id="result_game" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Round
		WHERE
			season	= #{season} AND
			round	= #{round}
	
	</select>
	
	
<!--	 Result Season	-->
	
	<select id="result_season">
	
		SELECT player, avg(rating),sum(goal),sum(assist), max(rating)+sum(goal)+sum(assist) FROM less.Score group by player
	
	</select>
	
</mapper>