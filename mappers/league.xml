<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="League">


<!--	League Season Round		-->

	<select id="season_round" resultType="map">
		
		SELECT
			*
		FROM
			Season
		ORDER BY
			season DESC
		LIMIT
			1
		
	</select>
	
	
<!--	League information		-->

	<select id="information" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Club
		WHERE
			roster = 1
		ORDER BY
			ovr DESC
	
	</select>
	
	
<!--	Key Player		-->

	<select id="keyplayer" resultType="map">
	
		SELECT
			*
		FROM
			Player
		WHERE
			club = #{name}
		ORDER BY
			ovr DESC
		LIMIT
			1
			
	</select>
	
	
<!--	Ranking		-->

	<select id="ranking" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Ranking
		WHERE
			round = #{round}
		ORDER BY
			point DESC
	
	</select>
	
	
<!--	Match		-->

	<select id="match" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Round
		WHERE
			season	= #{season} AND
			round	= #{round}
	
	</select>
	
	
<!--	Match schedule		-->

	<insert id="match_schedule" parameterType="map">
	
		<foreach collection="versus" index="idx" separator=";" close=";">
		
			INSERT
				INTO Round (
					season,
					round,
					versus
				)
				VALUES (
					#{season},
					#{round},
					#{versus[${idx}]}
				)
		
		</foreach>
		<foreach collection="club" index="idx" separator=";">
		
			INSERT
				INTO Ranking (
					season,
					round,
					club
				)
				VALUES (
					#{season},
					#{round},
					#{club[${idx}]}
				)
		
		</foreach>
	
	</insert>
	
	
<!--	Update Season		-->

	<update id="update_season" parameterType="map">
	
		UPDATE
			League
		SET
			round = 1
		WHERE
			season = #{season};
			
		UPDATE
			Season
		SET
			round = 1
		WHERE
			season = #{season}
	
	</update>
	
	
<!--	Lineup		-->

	<select id="lineup" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			${role}
		WHERE
			club = #{name}
			
	</select>
	
	
<!--	Insert Score		-->

	<insert id="insert_score" parameterType="map">
	
		INSERT
			INTO Score (
				season,
				round,
				club,
				player,
				rating,
				goal,
				assist,
				opponent
			)
			VALUES (
				#{season},
				#{round},
				#{club},
				#{name},
				#{rating},
				#{goal},
				#{assist},
				#{opponent}
			)
	
	</insert>
	
	
<!--	Update Round		-->

	<update id="update_round" parameterType="map">
	
		UPDATE
			Round
		SET
			lineup	= #{lineup},
			score	= #{score}
		WHERE
			season	= #{season}	AND
			round	= #{round}	AND
			versus	= #{versus}
	
	</update>
	
	
<!--	Update Ranking	-->
	
	<update id="update_ranking" parameterType="map">
	
		UPDATE
			Ranking
		SET
			game	= #{round},
		<if test="win != null">
			win 	= ${win} + 
				(SELECT * FROM 
					(
						SELECT
							win
						FROM
							Ranking
						WHERE
							season	= #{season}	AND
							round	= #{round}	AND
							club	= #{name}
					) AS win
				)
		</if>
		<if test="draw != null">
			draw	= ${draw} + 
				(SELECT * FROM 
					(
						SELECT
							draw
						FROM
							Ranking
						WHERE
							season	= #{season}	AND
							round	= #{round}	AND
							club	= #{name}
					) AS draw
				)
		</if>
		<if test="lose != null">
			lose	= ${lose} + 
				(SELECT * FROM 
					(
						SELECT
							lose
						FROM
							Ranking
						WHERE
							season	= #{season}	AND
							round	= #{round}	AND
							club	= #{name}
					) AS lose
				)
		</if>
		WHERE
			season	= #{season}	AND
			round	= #{round}	AND
			club	= #{name};
			
		UPDATE
			Ranking
		SET
			point = 
				(SELECT wd.win * 3 + wd.draw FROM 
					(
						SELECT
							win, draw
						FROM
							Ranking
						WHERE
							season	= #{season}	AND
							round	= #{round}	AND
							club	= #{name}
					) AS wd
				)
		WHERE
			season	= #{season}	AND
			round	= #{round}	AND
			club	= #{name}
	
	
	</update>
	
	
<!--	Check Round		-->

	<select id="check_round" parameterType="map" resultType="int">
	
		SELECT
			MAX(round) = ${round}
		FROM
			Round
		WHERE
			season = #{season}
	
	</select>
	
	
<!--	Next Round		-->

	<update id="next_round" parameterType="map">
	
		UPDATE
			League
		SET
			Round	= #{round+1}
		WHERE
			season	= #{season};
			
		
	
	</update>
	
	
<!--	Result Game		-->
	
	<select id="result_game" parameterType="map" resultType="map">
	
		SELECT
			*
		FROM
			Round
		WHERE
			season	= #{season} AND
			round	= #{round}
	
	</select>
	
	
</mapper>